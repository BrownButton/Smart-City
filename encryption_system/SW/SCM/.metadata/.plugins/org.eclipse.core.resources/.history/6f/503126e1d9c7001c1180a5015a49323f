/*
 * freertos_functions.c
 *
 *  Created on: Dec 18, 2021
 *      Author: Hyun-Ho Cha
 */
#include "cmsis_os.h"
#include "lwip.h"
#include "netbuf.h"
#include "api.h"

void Unit_Side_Data_Task(void const * argument)
{

	struct netconn *conn;
	err_t err;
	struct netbuf *buf, *send_buf;
	uint16_t len;
	uint16_t port;
	ip_addr_t *addr;
	uint8_t* payload, send_payload;

	/* init code for LWIP */
	LWIP_UNUSED_ARG(argument);

	conn = netconn_new(NETCONN_UDP); //new udp netconn

	if (conn != NULL)
	{
	  err = netconn_bind(conn, NULL, 1500); // bind to port

	  if (err == ERR_OK)
	  {
		  while(1)
		  {

			while(netconn_recv(conn, &buf) != ERR_OK);

			addr = netbuf_fromaddr(buf);
			port = netbuf_fromport(buf);

			len = buf->p->len;
			payload = buf->p->payload;

			send_buf = netbuf_new();
			send_payload = netbuf_alloc(send_buf, len);
			memcpy(send_payload, payload, len);

			netconn_sendto(conn, send_buf, addr, 1501); // Send packet

			netbuf_delete(send_buf);

			netbuf_delete(buf);

		  }
	  }
	}
	else
	{
	  netconn_delete(conn);
	}

}

void SCM_Side_Data_Task(void const * argument)
{

  for(;;)
  {

    osDelay(1);
  }

}
